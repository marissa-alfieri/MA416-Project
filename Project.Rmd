---
title: "Life Expectancy Trends (2000-2015)"
author: "Marissa Alfieri, Jenny Zheng, Letitia Caspersen"
date: "2025-11-04"
output:
  pdf_document:
    latex_engine: xelatex
---

## Introduction

Life expectancy says a lot about how people live and the conditions they face around the world. It’s shaped by many factors: healthcare access, education, the economy, environment, and even culture. Some countries have seen major improvements over time, while others are still catching up. This project looks at how life expectancy has changed between 2000 and 2015 and whether there are significant differences between continents. In other words, what influences life expectancy, and which regions tend to have the highest averages?

The data for this project comes from Kaggle (“[Life Expectancy 2000–2015](https://www.kaggle.com/datasets/vrec99/life-expectancy-2000-2015)”), which merges several reliable global sources. It includes data for 119 countries across 15 years. Along with life expectancy, the dataset also tracks GDP per capita, CO₂ emissions, healthcare expenditure, population size, internet access, forest area, and other socioeconomic indicators.

## One factor ANOVA test

This one-way anova analysis is to determine whether the mean life expectancy differs significantly among continents in the year 2005. Since each country contributes only one observation for 2005, the assumption of independence is satisfied by design. For the main study we want to test if the mean life expectancy is the same across all continents in 2005. With the alternative being at least one of the means differs significantly.

$$
\ H_0: \mu_{\text{Africa}} = \mu_{\text{Asia}} = \mu_{\text{Europe}} = \mu_{\text{Americas}} = \mu_{\text{Oceania}} \quad \text{vs.} \quad H_a: \text{at least one mean differs.} 
$$

First, the dataset was imported and filtered for the year 2005 to ensure independent observations. 

```{r 1}
mydata = read.csv("Life_Expectancy_clean.csv")
mydata_2005 = subset(mydata, Year == 2005)
x = mydata_2005$Life.Expectancy
```

Before we can do the actual testing, we have to make sure all the assumptions are met, first of which being normality. It is important because ANOVA assumes that residuals within each group are normally distributed. 

$$
\ H_0: \text{The life expectancy values within each continent are normally distributed.} \\
\ H_a: \text{The life expectancy values within at least one continent deviate from normality.}
$$

To evaluate the assumption of normality, histograms were created for each continent using life expectancy as the variable of interest. Visual inspection of the histograms suggested that the distributions were varied, with some having approximately bell shaped curves, some with unique distributions, and some skewed.

```{r, fig.width=3.5, fig.height=2.5, echo=FALSE}
continents = unique(mydata_2005$Continent)
		
for (c in continents){
subset_data=mydata_2005$Life.Expectancy[mydata_2005$Continent == c]
  
 			 hist(subset_data,
  			     main = paste("Life Expectancy in", c, "2005"),
       xlab = "Life Expectancy",
       ylab = "Frequency",
       col = "skyblue",
       breaks = 5)
}

```

However, visual methods alone cannot confirm normality so a computational Monte Carlo Anderson Darling based normality test was used. This test calculates the difference between the theoretical cumulative distribution function (CDF) of a normal distribution with the same sample mean and standard deviation and the empirical CDF of the observed data. Since there is no known analytical reference distribution for this statistic, random normal samples were drawn under the assumption of normality to create a simulated null distribution. 

```{r 3}
set.seed(123123)
nmc = length(x)
n= length(x)
mc_ad = c()

for(k in 1:nmc){
  smc = rnorm(n, 0, 1)
  smc <- sort(smc)
  fxmc= (1:n)/(n+1)
  		  psixmc = pnorm(smc, 0, 1)
  		  mc_ad = c(mc_ad, sum((fxmc - psixmc)^2 / (fxmc * (1 - fxmc))))
  
}
ad_crit = quantile(mc_ad, 1- .1)
emp_pval = mean(mc_ad >= 1.0185)
emp_pval
```

To ensure that each simulated normal dataset matched the sample size of the actual data, the number of Monte Carlo replications for this simulation was set to the number of observations in the 2005 life expectancy sample. A sample of n standard normal values was taken for each repetition, sorted, and compared to the theoretical normal CDF. A null distribution representing expected variability with normality was created by the simulated statistics that was produced. The observed test statistic for the life expectancy data was compared to this simulated distribution to obtain a p-value. The p-value was approximately .3782, which is greater than the alpha level of 0.10, leading to the decision to fail to reject the null hypothesis of normality. This outcome indicates that the life expectancy data are approximately normal across continents and that the normality assumption is sufficiently satisfied for ANOVA.

The next assumption examined is homoscedasticity, which requires that the population variances be equal across the groups being compared.

$$
\ H_0: \text{The variances of life expectancy among continents are equal.} \\
\ H_a: \text{At least one group’s variance differs.}
$$

A Bartlett’s test was conducted to evaluate this assumption. 

```{r 4}
xs = split(x, mydata_2005$Continent)
xbarj = sapply(xs, mean)
s2j = sapply(xs, var)
nj= sapply (xs, length)
vj= nj-1
g= length(unique(mydata_2005$Continent))
sp2 = sum(vj * s2j)/ sum(vj)
bartop= (sum(vj)* log(sp2)) - sum(vj* log(s2j))
barbot = 1+ 1/(3*(g-1))* (sum(1/vj)- 1/sum(vj))
bastat= bartop/ barbot
BA_crit = qchisq(1-.1, g-1)
pval = pchisq(bastat, g-1, lower.tail= F)
pval
```

The Bartlett statistic was computed as the difference between the weighted logarithm of the pooled variance and the sum of the weighted logarithms of each group variance, scaled by a small-sample correction factor. The resulting statistic follows a chi-squared distribution with k−1 degrees of freedom, where k is the number of groups (continents). The p-value associated with this test was less than 0, leading to the rejection of the null hypothesis of equal variances. Therefore, the homoscedastic assumption was not satisfied, indicating that variability in life expectancy differs significantly among continents. 

Based on the study design, the last assumption, independence, was conceptually confirmed. There are no repeated measures for the same country in 2005, and each observation represents a different nation. As a result, both within and between groups, the observations are independent.

But because the equal-variance assumption was violated, a heteroscedastic (or weighted) one-way ANOVA was performed in place of the standard version. This approach, Welch’s ANOVA, accounts for unequal variances by weighting each group mean according to the inverse of its variance. The inverse-variance weights were computed as:

```{r 5}
w = nj / s2j  
```

Where nj is the sample size and the s2j for the sample variance for the ith continent. The weighted grand mean was then calculated as the sum of the weighted group means divided by the sum of the weights. 

```{r 6}
			grand_mean_hetero = sum(w * xbarj) / sum(w)
```

The weighted sum of squares between groups was obtained by measuring each group mean’s deviation from the weighted grand mean, multiplied by its respective weight. This value was divided by the number of groups minus one to obtain the weighted mean square for the model. 

```{r 7}
SSMstar = sum(w*(xbarj - grand_mean_hetero)^2)
MSMstar= SSMstar/ (g-1)
MSEdf_hetero = (sum(w)^2) / sum( (w^2) / (nj - 1) )
```

The test statistic, F, was computed as the ratio of this weighted mean square to a variance adjustment term that accounts for the degrees of freedom in heteroscedastic conditions. 

```{r 8}
V_h_top = (sum(nj/s2j))^2
V_h_bot = sum(nj^2/(s2j^2*(nj-1)))
v_h = V_h_top/V_h_bot
Fstat_h = MSMstar / (1+2*(g-2)/v_h)
pf(Fstat_h, g-1, v_h, lower.tail = F)
```

The resulting p-value was less than 0.10, which led to the rejection of the null hypothesis that all continental means are equal. At the 10 percent significance level, the analysis provides evidence that mean life expectancy differs significantly among continents in 2005. Although the assumption of equal variances was violated, the use of the heteroscedastic ANOVA approach ensures that the statistical inference remains valid. The normality and independence assumptions were met, thereby strengthening confidence in the results.

## Repeated-Measures ANOVA test

While the one-way ANOVA looked at whether life expectancy differed between continents in a single year, the repeated-measures ANOVA examines how life expectancy changed over time within the same continents. Each continent represents a single subject measured repeatedly from 2000 to 2015. This allows us to see if the average life expectancy changed significantly during that period.

The hypotheses for this test are:

$$
\ H_0: \mu_{\text{2000}} = \mu_{\text{2001}} = \mu_{\text{2002}}  = ... = \mu_{\text{2015}} \quad \text{vs.} \quad H_a: \text{at least one mean differs.} 
$$

Before running the repeated-measures ANOVA, it is important to check the main assumptions: normality, sphericity, and independence.

**1. Normality**

Before running the repeated-measures ANOVA, I checked the normality assumption using the Lilliefors Kolmogorov–Smirnov test. The null hypothesis states that the data follows a normal distribution, while the alternative suggests that they deviate from normality. I used a Monte Carlo simulation to create a null distribution for the KS statistic by repeatedly sampling from a normal distribution. This helped me get a more accurate p-value and confirm whether the normality assumption was met.

```{r m1}
set.seed(123123)
x = mydata$Life.Expectancy
mc_ks = c()
x_sorted = sort(x)
n = length(x_sorted)

# Lilliefors Kolmogorov–Smirnov test
F_emp = (1:n) / (n+1) 
F_null = pnorm(x_sorted, mean(x_sorted), sd(x_sorted)) 
KS_obs = max(abs(F_emp - F_null))
KS_obs

# Monte Carlo simulation
for (k in 1:nmc) {
  Smc = sort(rnorm(n, mean(x), sd(x)))             
  F_emp_mc = (1:n) / (n + 1)          
  F_null_mc = pnorm(Smc, mean(Smc), sd(Smc))      
  mc_ks = c(mc_ks, max(abs(F_emp_mc - F_null_mc)))
}
emp_pval = mean(mc_ks >= KS_obs)
emp_pval
```

The results of the Lilliefors Kolmogorov–Smirnov test indicated that the life expectancy data deviate from a normal distribution. The observed KS statistic was 0.129, and the Monte Carlo simulation with 10,000 replications returned a p-value of approximately 0, which is below the alpha level of 0.10. Therefore, the null hypothesis of normality was rejected. This suggests that the life expectancy data are not perfectly normal.

Since the normality assumption was violated, I used a bootstrap approach to get an empirical p-value for the repeated-measures ANOVA. I generated 10,000 bootstrap samples by resampling the continents with replacement and recalculated the F-statistic for each sample. The bootstrap distribution of those F-values was then compared to the observed statistic to estimate the p-value. This method lets me test whether life expectancy changed significantly over time without having to rely on the normality assumption.

```{r m2}
source("functions.R")
X = tapply(mydata$Life.Expectancy,
            list(mydata$Continent, mydata$Year),
            mean)
X = as.matrix(X)


set.seed(123123)
N = 10000

F_obs = rm.ANOVA(X)$Fstat
F_boot = c()
n = nrow(X)

for (k in 1:N) {
  boot_index = sample(1:n, n, replace = TRUE)
  X_boot = X[boot_index, ]
  F_boot = c(F_boot, rm.ANOVA(X_boot)$Fstat)
}

p_boot = mean(F_boot >= F_obs)

F_obs
p_boot

```

Using a bootstrap approach with 10,000 replications, the empirical p-value for the repeated-measures ANOVA was approximately 0.67. This suggests that the observed F-statistic (F = 22.96) is not extreme under the null distribution, meaning there is no significant evidence that mean life expectancy changed across years. In other words, life expectancy remained relatively stable over the 2000–2015 period when accounting for variability between continents.
